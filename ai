import org.apache.kafka.clients.producer.ProducerRecord;
import org.apache.kafka.common.header.Header;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.ArgumentCaptor;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.springframework.kafka.core.KafkaTemplate;
import org.springframework.kafka.support.SendResult;
import org.springframework.test.util.ReflectionTestUtils;

import javax.jms.TextMessage;
import java.nio.charset.StandardCharsets;
import java.util.concurrent.CompletableFuture;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class MQL2FraudServiceTest {

    @Mock
    private KafkaTemplate<String, Object> producer;

    @InjectMocks
    private MQL2FraudService service;

    @Test
    void shouldPublishToKafka_whenValidTextMessage_andAvroFormat() throws Exception {
        // Arrange
        ReflectionTestUtils.setField(service, "topicName", "my-topic");
        ReflectionTestUtils.setField(service, "messageFormat", "avro");

        TextMessage textMessage = mock(TextMessage.class);

        // must be 3 parts split by "\n\r"
        // payloadArr[0] ends with delimiter; code does substring(0, len-1)
        when(textMessage.getText()).thenReturn("TXN123|\n\rSOME_DATA\n\r00");

        // KafkaTemplate.send returns CompletableFuture (Spring Kafka 3.x)
        CompletableFuture<SendResult<String, Object>> okFuture = CompletableFuture.completedFuture(mock(SendResult.class));
        when(producer.send(any(ProducerRecord.class))).thenReturn(okFuture);

        // Act
        service.onL2MessageEvent(textMessage);

        // Assert - capture record
        ArgumentCaptor<ProducerRecord<String, Object>> captor = ArgumentCaptor.forClass(ProducerRecord.class);
        verify(producer, times(1)).send(captor.capture());

        ProducerRecord<String, Object> rec = captor.getValue();
        assertEquals("my-topic", rec.topic());
        assertEquals("TXN123", rec.key());
        assertNotNull(rec.value());

        Header h = rec.headers().lastHeader("kafka_correlationId");
        assertNotNull(h);
        assertEquals("TXN123", new String(h.value(), StandardCharsets.UTF_8));
    }

    @Test
    void shouldIgnore_whenPayloadPatternInvalid() throws Exception {
        ReflectionTestUtils.setField(service, "messageFormat", "avro");

        TextMessage textMessage = mock(TextMessage.class);
        when(textMessage.getText()).thenReturn("TXN123|\n\rONLY_TWO_PARTS");

        service.onL2MessageEvent(textMessage);

        verify(producer, never()).send(any());
    }

    @Test
    void shouldNotThrow_whenProducerThrows() throws Exception {
        ReflectionTestUtils.setField(service, "topicName", "my-topic");
        ReflectionTestUtils.setField(service, "messageFormat", "avro");

        TextMessage textMessage = mock(TextMessage.class);
        when(textMessage.getText()).thenReturn("TXN123|\n\rSOME_DATA\n\r00");

        when(producer.send(any(ProducerRecord.class)))
                .thenThrow(new RuntimeException("Kafka down"));

        assertDoesNotThrow(() -> service.onL2MessageEvent(textMessage));

        verify(producer, times(1)).send(any());
    }
}