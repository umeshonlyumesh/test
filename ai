import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

import java.nio.charset.StandardCharsets;

import org.apache.kafka.clients.producer.ProducerRecord;
import org.apache.kafka.clients.producer.RecordMetadata;
import org.apache.kafka.common.header.Header;
import org.junit.jupiter.api.Test;
import org.mockito.ArgumentCaptor;

class YourTest {

  @Test
  void shouldProcessValidTextMessageAndPublishToKafka() throws Exception {
    // Arrange
    String payload = "TXN1234||SOME_DATA|RELEASE";
    when(textMessage.getText()).thenReturn(payload);

    RecordMetadata metadata = mock(RecordMetadata.class);
    when(metadata.partition()).thenReturn(1);
    when(metadata.offset()).thenReturn(10L);

    // IMPORTANT: stub the real signature (single ProducerRecord arg)
    when(producer.sendSync(Mockito.<ProducerRecord<String, Object>>any()))
        .thenReturn(metadata);

    // Act
    service.onL2MessageEvent(textMessage);

    // Assert: capture the ProducerRecord passed to sendSync(...)
    ArgumentCaptor<ProducerRecord<String, Object>> captor =
        ArgumentCaptor.forClass((Class) ProducerRecord.class);

    verify(producer, times(1)).sendSync(captor.capture());

    ProducerRecord<String, Object> rec = captor.getValue();

    // key
    assertEquals("TXN1234", rec.key());

    // value type (adjust class name if your payload object differs)
    assertNotNull(rec.value());
    assertTrue(rec.value() instanceof L2);

    // header
    Header h = rec.headers().lastHeader("kafka_correlationId");
    assertNotNull(h, "kafka_correlationId header must be present");
    assertEquals("TXN1234", new String(h.value(), StandardCharsets.UTF_8));

    // topic (if you know expected topic, assert it)
    // assertEquals("your-topic", rec.topic());
  }
}