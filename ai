import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.MockedStatic;
import org.mockito.junit.jupiter.MockitoExtension;

import java.util.List;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

@ExtendWith(MockitoExtension.class)
class AlertValidatorFullCoverageTest {

    @Test
    void headerNull_branch() {
        CoreIntegrationRequest request = mock(CoreIntegrationRequest.class);
        when(request.getHeader()).thenReturn(null);

        assertThrows(ValidationException.class,
                () -> AlertValidator.validate(request, mock(ValidationProperties.class)));
    }

    @Test
    void customerAlertNull_branch() {
        ValidationProperties props = mock(ValidationProperties.class);
        CoreIntegrationRequest request = mock(CoreIntegrationRequest.class);

        Header header = mock(Header.class);
        when(request.getHeader()).thenReturn(header);
        when(request.getCustomerAlert()).thenReturn(null);

        try (MockedStatic<HeaderValidation> mocked = mockStatic(HeaderValidation.class)) {
            mocked.when(() -> HeaderValidation.headerValidation(header, props))
                    .thenAnswer(inv -> null); // void static

            assertThrows(ValidationException.class,
                    () -> AlertValidator.validate(request, props));
        }
    }

    @Test
    void parametersEmpty_branch() {
        ValidationProperties props = mock(ValidationProperties.class);
        CoreIntegrationRequest request = mock(CoreIntegrationRequest.class);

        Header header = mock(Header.class);
        when(request.getHeader()).thenReturn(header);

        CustomerAlert alert = mock(CustomerAlert.class);
        when(request.getCustomerAlert()).thenReturn(alert);
        when(alert.getParameters()).thenReturn(List.of()); // empty

        try (MockedStatic<HeaderValidation> mocked = mockStatic(HeaderValidation.class)) {
            mocked.when(() -> HeaderValidation.headerValidation(header, props))
                    .thenAnswer(inv -> null);

            assertThrows(ValidationException.class,
                    () -> AlertValidator.validate(request, props));
        }
    }

    @Test
    void sourceIdUnsupported_elseBranch() {
        ValidationProperties props = mock(ValidationProperties.class);
        CoreIntegrationRequest request = mock(CoreIntegrationRequest.class);

        Header header = mock(Header.class);
        when(request.getHeader()).thenReturn(header);
        when(header.getSourceId()).thenReturn("SOMETHING_ELSE"); // else path

        CustomerAlert alert = mock(CustomerAlert.class);
        when(request.getCustomerAlert()).thenReturn(alert);
        when(alert.getParameters()).thenReturn(List.of(param("partyOlbNumber", "123"))); // non-empty

        try (MockedStatic<HeaderValidation> mocked = mockStatic(HeaderValidation.class)) {
            mocked.when(() -> HeaderValidation.headerValidation(header, props))
                    .thenAnswer(inv -> null);

            assertThrows(ValidationException.class,
                    () -> AlertValidator.validate(request, props));
        }
    }

    @Test
    void partyOlbNumberBlank_specialRuleBranch() {
        ValidationProperties props = mock(ValidationProperties.class);
        CoreIntegrationRequest request = mock(CoreIntegrationRequest.class);

        Header header = mock(Header.class);
        when(request.getHeader()).thenReturn(header);
        when(header.getSourceId()).thenReturn("PE-zelle");

        CustomerAlert alert = mock(CustomerAlert.class);
        when(request.getCustomerAlert()).thenReturn(alert);

        when(alert.getParameters()).thenReturn(List.of(
                param("partyOlbNumber", ""),          // special rule fail
                param("channelId", "PEZELLE"),
                param("eventType", "ALERT"),
                param("partyIdType", "OLB")
        ));

        try (MockedStatic<HeaderValidation> mocked = mockStatic(HeaderValidation.class)) {
            mocked.when(() -> HeaderValidation.headerValidation(header, props))
                    .thenAnswer(inv -> null);

            assertThrows(ValidationException.class,
                    () -> AlertValidator.validate(request, props));
        }
    }

    @Test
    void partyOlbNumberMissing_specialRuleBranch() {
        ValidationProperties props = mock(ValidationProperties.class);
        CoreIntegrationRequest request = mock(CoreIntegrationRequest.class);

        Header header = mock(Header.class);
        when(request.getHeader()).thenReturn(header);
        when(header.getSourceId()).thenReturn("PE-zelle");

        CustomerAlert alert = mock(CustomerAlert.class);
        when(request.getCustomerAlert()).thenReturn(alert);

        // No partyOlbNumber key at all -> your logic hits actualValue==null branch when key is partyOlbNumber
        when(alert.getParameters()).thenReturn(List.of(
                param("channelId", "PEZELLE"),
                param("eventType", "ALERT"),
                param("partyIdType", "OLB")
        ));

        try (MockedStatic<HeaderValidation> mocked = mockStatic(HeaderValidation.class)) {
            mocked.when(() -> HeaderValidation.headerValidation(header, props))
                    .thenAnswer(inv -> null);

            assertThrows(ValidationException.class,
                    () -> AlertValidator.validate(request, props));
        }
    }

    @Test
    void expectedKeyMissing_generalMissingBranch() {
        ValidationProperties props = mock(ValidationProperties.class);
        CoreIntegrationRequest request = mock(CoreIntegrationRequest.class);

        Header header = mock(Header.class);
        when(request.getHeader()).thenReturn(header);
        when(header.getSourceId()).thenReturn("PE-zelle");

        CustomerAlert alert = mock(CustomerAlert.class);
        when(request.getCustomerAlert()).thenReturn(alert);

        // Missing "channelId" (which is in EXPECTED_VALUES)
        when(alert.getParameters()).thenReturn(List.of(
                param("partyOlbNumber", "123"),
                param("eventType", "ALERT"),
                param("partyIdType", "OLB")
        ));

        try (MockedStatic<HeaderValidation> mocked = mockStatic(HeaderValidation.class)) {
            mocked.when(() -> HeaderValidation.headerValidation(header, props))
                    .thenAnswer(inv -> null);

            assertThrows(ValidationException.class,
                    () -> AlertValidator.validate(request, props));
        }
    }

    @Test
    void expectedValueMismatch_branch() {
        ValidationProperties props = mock(ValidationProperties.class);
        CoreIntegrationRequest request = mock(CoreIntegrationRequest.class);

        Header header = mock(Header.class);
        when(request.getHeader()).thenReturn(header);
        when(header.getSourceId()).thenReturn("PE-zelle");

        CustomerAlert alert = mock(CustomerAlert.class);
        when(request.getCustomerAlert()).thenReturn(alert);

        // channelId wrong -> mismatch branch
        when(alert.getParameters()).thenReturn(List.of(
                param("partyOlbNumber", "123"),
                param("channelId", "WRONG"),
                param("eventType", "ALERT"),
                param("partyIdType", "OLB")
        ));

        try (MockedStatic<HeaderValidation> mocked = mockStatic(HeaderValidation.class)) {
            mocked.when(() -> HeaderValidation.headerValidation(header, props))
                    .thenAnswer(inv -> null);

            assertThrows(ValidationException.class,
                    () -> AlertValidator.validate(request, props));
        }
    }

    @Test
    void happyPath_noException() {
        ValidationProperties props = mock(ValidationProperties.class);
        CoreIntegrationRequest request = mock(CoreIntegrationRequest.class);

        Header header = mock(Header.class);
        when(request.getHeader()).thenReturn(header);
        when(header.getSourceId()).thenReturn("PE-zelle");

        CustomerAlert alert = mock(CustomerAlert.class);
        when(request.getCustomerAlert()).thenReturn(alert);

        when(alert.getParameters()).thenReturn(List.of(
                param("partyOlbNumber", "123"),
                param("channelId", "PEZELLE"),
                param("eventType", "ALERT"),
                param("partyIdType", "OLB")
        ));

        try (MockedStatic<HeaderValidation> mocked = mockStatic(HeaderValidation.class)) {
            mocked.when(() -> HeaderValidation.headerValidation(header, props))
                    .thenAnswer(inv -> null);

            assertDoesNotThrow(() -> AlertValidator.validate(request, props));
        }
    }

    @Test
    void duplicateKey_inCollectorsToMap_branch() {
        ValidationProperties props = mock(ValidationProperties.class);
        CoreIntegrationRequest request = mock(CoreIntegrationRequest.class);

        Header header = mock(Header.class);
        when(request.getHeader()).thenReturn(header);
        when(header.getSourceId()).thenReturn("PE-zelle");

        CustomerAlert alert = mock(CustomerAlert.class);
        when(request.getCustomerAlert()).thenReturn(alert);

        // Two parameters with same fieldId => Collectors.toMap throws IllegalStateException
        when(alert.getParameters()).thenReturn(List.of(
                param("partyOlbNumber", "123"),
                param("partyOlbNumber", "456"),
                param("channelId", "PEZELLE"),
                param("eventType", "ALERT"),
                param("partyIdType", "OLB")
        ));

        try (MockedStatic<HeaderValidation> mocked = mockStatic(HeaderValidation.class)) {
            mocked.when(() -> HeaderValidation.headerValidation(header, props))
                    .thenAnswer(inv -> null);

            assertThrows(IllegalStateException.class,
                    () -> AlertValidator.validate(request, props));
        }
    }

    private static Parameter param(String id, String value) {
        Parameter p = mock(Parameter.class);
        when(p.getFieldId()).thenReturn(id);
        when(p.getFieldValue()).thenReturn(value);
        return p;
    }
}