import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.MockedStatic;
import org.mockito.junit.jupiter.MockitoExtension;

import java.util.List;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

// Adjust package/imports based on your project
@ExtendWith(MockitoExtension.class)
class AlertValidatorTest {

    private ValidationProperties validationProperties;

    @BeforeEach
    void setUp() {
        validationProperties = mock(ValidationProperties.class);
    }

    @Test
    void validate_whenHeaderNull_shouldThrowValidationException() {
        CoreIntegrationRequest request = mock(CoreIntegrationRequest.class);
        when(request.getHeader()).thenReturn(null);

        ValidationException ex = assertThrows(
                ValidationException.class,
                () -> AlertValidator.validate(request, validationProperties)
        );

        assertNotNull(ex);
    }

    @Test
    void validate_whenCustomerAlertNull_shouldThrowValidationException() {
        CoreIntegrationRequest request = mock(CoreIntegrationRequest.class);

        Header header = mock(Header.class);
        when(request.getHeader()).thenReturn(header);

        // sourceId must be PE-zelle to reach alert checks? (your code checks customerAlert before sourceId block)
        when(header.getSourceId()).thenReturn("PE-zelle");

        when(request.getCustomerAlert()).thenReturn(null);

        try (MockedStatic<HeaderValidation> mocked = mockStatic(HeaderValidation.class)) {
            mocked.when(() -> HeaderValidation.headerValidation(header, validationProperties)).thenReturn(null);

            ValidationException ex = assertThrows(
                    ValidationException.class,
                    () -> AlertValidator.validate(request, validationProperties)
            );

            assertNotNull(ex);
        }
    }

    @Test
    void validate_whenParametersEmpty_shouldThrowValidationException() {
        CoreIntegrationRequest request = mock(CoreIntegrationRequest.class);

        Header header = mock(Header.class);
        when(request.getHeader()).thenReturn(header);
        when(header.getSourceId()).thenReturn("PE-zelle");

        CustomerAlert customerAlert = mock(CustomerAlert.class);
        when(request.getCustomerAlert()).thenReturn(customerAlert);

        when(customerAlert.getParameters()).thenReturn(List.of()); // empty list

        try (MockedStatic<HeaderValidation> mocked = mockStatic(HeaderValidation.class)) {
            mocked.when(() -> HeaderValidation.headerValidation(header, validationProperties)).thenReturn(null);

            ValidationException ex = assertThrows(
                    ValidationException.class,
                    () -> AlertValidator.validate(request, validationProperties)
            );

            assertNotNull(ex);
        }
    }

    @Test
    void validate_whenUnsupportedSourceId_shouldThrowValidationException() {
        CoreIntegrationRequest request = mock(CoreIntegrationRequest.class);

        Header header = mock(Header.class);
        when(request.getHeader()).thenReturn(header);
        when(header.getSourceId()).thenReturn("SOME_OTHER_SOURCE");

        CustomerAlert customerAlert = mock(CustomerAlert.class);
        when(request.getCustomerAlert()).thenReturn(customerAlert);

        // ensure not empty so it reaches sourceId else-block
        when(customerAlert.getParameters()).thenReturn(List.of(mock(Parameter.class)));

        try (MockedStatic<HeaderValidation> mocked = mockStatic(HeaderValidation.class)) {
            mocked.when(() -> HeaderValidation.headerValidation(header, validationProperties)).thenReturn(null);

            ValidationException ex = assertThrows(
                    ValidationException.class,
                    () -> AlertValidator.validate(request, validationProperties)
            );

            assertNotNull(ex);
        }
    }

    @Test
    void validate_whenPartyOlbNumberEmpty_shouldThrowValidationException() {
        CoreIntegrationRequest request = mock(CoreIntegrationRequest.class);

        Header header = mock(Header.class);
        when(request.getHeader()).thenReturn(header);
        when(header.getSourceId()).thenReturn("PE-zelle");

        CustomerAlert customerAlert = mock(CustomerAlert.class);
        when(request.getCustomerAlert()).thenReturn(customerAlert);

        // Build parameters map missing/blank partyOlbNumber
        Parameter p1 = param("partyOlbNumber", ""); // should fail by your special rule
        Parameter p2 = param("channelId", "PEZELLE");
        Parameter p3 = param("eventType", "ALERT");
        Parameter p4 = param("partyIdType", "OLB");

        when(customerAlert.getParameters()).thenReturn(List.of(p1, p2, p3, p4));

        try (MockedStatic<HeaderValidation> mocked = mockStatic(HeaderValidation.class)) {
            mocked.when(() -> HeaderValidation.headerValidation(header, validationProperties)).thenReturn(null);

            ValidationException ex = assertThrows(
                    ValidationException.class,
                    () -> AlertValidator.validate(request, validationProperties)
            );

            assertNotNull(ex);
        }
    }

    @Test
    void validate_whenExpectedValueMismatch_shouldThrowValidationException() {
        CoreIntegrationRequest request = mock(CoreIntegrationRequest.class);

        Header header = mock(Header.class);
        when(request.getHeader()).thenReturn(header);
        when(header.getSourceId()).thenReturn("PE-zelle");

        CustomerAlert customerAlert = mock(CustomerAlert.class);
        when(request.getCustomerAlert()).thenReturn(customerAlert);

        // channelId mismatch
        Parameter p1 = param("partyOlbNumber", "12345");
        Parameter p2 = param("channelId", "WRONG");
        Parameter p3 = param("eventType", "ALERT");
        Parameter p4 = param("partyIdType", "OLB");

        when(customerAlert.getParameters()).thenReturn(List.of(p1, p2, p3, p4));

        try (MockedStatic<HeaderValidation> mocked = mockStatic(HeaderValidation.class)) {
            mocked.when(() -> HeaderValidation.headerValidation(header, validationProperties)).thenReturn(null);

            ValidationException ex = assertThrows(
                    ValidationException.class,
                    () -> AlertValidator.validate(request, validationProperties)
            );

            assertNotNull(ex);
        }
    }

    @Test
    void validate_whenAllExpectedValuesMatch_shouldNotThrow() {
        CoreIntegrationRequest request = mock(CoreIntegrationRequest.class);

        Header header = mock(Header.class);
        when(request.getHeader()).thenReturn(header);
        when(header.getSourceId()).thenReturn("PE-zelle");

        CustomerAlert customerAlert = mock(CustomerAlert.class);
        when(request.getCustomerAlert()).thenReturn(customerAlert);

        Parameter p1 = param("partyOlbNumber", "12345");
        Parameter p2 = param("channelId", "PEZELLE");
        Parameter p3 = param("eventType", "ALERT");
        Parameter p4 = param("partyIdType", "OLB");

        when(customerAlert.getParameters()).thenReturn(List.of(p1, p2, p3, p4));

        try (MockedStatic<HeaderValidation> mocked = mockStatic(HeaderValidation.class)) {
            mocked.when(() -> HeaderValidation.headerValidation(header, validationProperties)).thenReturn(null);

            assertDoesNotThrow(() -> AlertValidator.validate(request, validationProperties));
        }
    }

    // ---------- helper ----------
    private static Parameter param(String fieldId, String fieldValue) {
        Parameter p = mock(Parameter.class);
        when(p.getFieldId()).thenReturn(fieldId);
        when(p.getFieldValue()).thenReturn(fieldValue);
        return p;
    }
}