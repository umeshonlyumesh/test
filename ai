@ExtendWith(MockitoExtension.class)
class AlertValidator100CoverageTest {

    private ValidationProperties props = mock(ValidationProperties.class);

    // ---------- A: HEADER ----------

    @Test
    void headerNull_shouldThrow() {
        CoreIntegrationRequest req = mock(CoreIntegrationRequest.class);
        when(req.getHeader()).thenReturn(null);

        assertThrows(ValidationException.class,
                () -> AlertValidator.validate(req, props));
    }

    // ---------- B: CUSTOMER ALERT ----------

    @Test
    void customerAlertNull_shouldThrow() {
        CoreIntegrationRequest req = baseRequest("PE-zelle");
        when(req.getCustomerAlert()).thenReturn(null);

        mockHeaderValidation(req);

        assertThrows(ValidationException.class,
                () -> AlertValidator.validate(req, props));
    }

    // ---------- C: PARAMETERS ----------

    @Test
    void parametersEmpty_shouldThrow() {
        CoreIntegrationRequest req = baseRequest("PE-zelle");

        CustomerAlert alert = mock(CustomerAlert.class);
        when(req.getCustomerAlert()).thenReturn(alert);
        when(alert.getParameters()).thenReturn(List.of());

        mockHeaderValidation(req);

        assertThrows(ValidationException.class,
                () -> AlertValidator.validate(req, props));
    }

    // ---------- D: SOURCE ID ----------

    @Test
    void unsupportedSourceId_shouldThrow() {
        CoreIntegrationRequest req = baseRequest("OTHER");

        CustomerAlert alert = mock(CustomerAlert.class);
        when(req.getCustomerAlert()).thenReturn(alert);
        when(alert.getParameters()).thenReturn(List.of(param("x","y")));

        mockHeaderValidation(req);

        assertThrows(ValidationException.class,
                () -> AlertValidator.validate(req, props));
    }

    // ---------- E1: partyOlbNumber blank ----------

    @Test
    void partyOlbNumberBlank_shouldThrow() {
        CoreIntegrationRequest req = peZelleRequest(
                param("partyOlbNumber",""),
                param("channelId","PEZELLE"),
                param("eventType","ALERT"),
                param("partyIdType","OLB")
        );

        mockHeaderValidation(req);

        assertThrows(ValidationException.class,
                () -> AlertValidator.validate(req, props));
    }

    // ---------- E2: partyOlbNumber missing ----------

    @Test
    void partyOlbNumberMissing_shouldThrow() {
        CoreIntegrationRequest req = peZelleRequest(
                param("channelId","PEZELLE"),
                param("eventType","ALERT"),
                param("partyIdType","OLB")
        );

        mockHeaderValidation(req);

        assertThrows(ValidationException.class,
                () -> AlertValidator.validate(req, props));
    }

    // ---------- E3: actualValue null ----------

    @Test
    void expectedKeyMissing_shouldThrow() {
        CoreIntegrationRequest req = peZelleRequest(
                param("partyOlbNumber","123"),
                param("eventType","ALERT"),
                param("partyIdType","OLB")
        ); // channelId missing

        mockHeaderValidation(req);

        assertThrows(ValidationException.class,
                () -> AlertValidator.validate(req, props));
    }

    // ---------- E4: value mismatch ----------

    @Test
    void valueMismatch_shouldThrow() {
        CoreIntegrationRequest req = peZelleRequest(
                param("partyOlbNumber","123"),
                param("channelId","WRONG"),
                param("eventType","ALERT"),
                param("partyIdType","OLB")
        );

        mockHeaderValidation(req);

        assertThrows(ValidationException.class,
                () -> AlertValidator.validate(req, props));
    }

    // ---------- F: HAPPY PATH ----------

    @Test
    void allValuesCorrect_shouldPass() {
        CoreIntegrationRequest req = peZelleRequest(
                param("partyOlbNumber","123"),
                param("channelId","PEZELLE"),
                param("eventType","ALERT"),
                param("partyIdType","OLB")
        );

        mockHeaderValidation(req);

        assertDoesNotThrow(() ->
                AlertValidator.validate(req, props));
    }

    // ---------- HELPERS ----------

    private CoreIntegrationRequest baseRequest(String sourceId) {
        CoreIntegrationRequest req = mock(CoreIntegrationRequest.class);
        Header header = mock(Header.class);
        when(header.getSourceId()).thenReturn(sourceId);
        when(req.getHeader()).thenReturn(header);
        return req;
    }

    private CoreIntegrationRequest peZelleRequest(Parameter... params) {
        CoreIntegrationRequest req = baseRequest("PE-zelle");

        CustomerAlert alert = mock(CustomerAlert.class);
        when(req.getCustomerAlert()).thenReturn(alert);
        when(alert.getParameters()).thenReturn(List.of(params));

        return req;
    }

    private void mockHeaderValidation(CoreIntegrationRequest req) {
        Header header = req.getHeader();
        try (MockedStatic<HeaderValidation> mocked =
                     mockStatic(HeaderValidation.class)) {
            mocked.when(() ->
                HeaderValidation.headerValidation(header, props)
            ).thenAnswer(inv -> null);
        }
    }

    private static Parameter param(String id, String value) {
        Parameter p = mock(Parameter.class);
        when(p.getFieldId()).thenReturn(id);
        when(p.getFieldValue()).thenReturn(value);
        return p;
    }
}