import org.apache.kafka.clients.consumer.ConsumerRecord;
import org.apache.kafka.common.errors.SerializationException;
import org.springframework.kafka.listener.ConsumerRecordRecoverer;
import org.springframework.kafka.support.serializer.DeserializationException;

import java.util.Objects;

public class NotifyingRecoverer implements ConsumerRecordRecoverer {

    private final ConsumerRecordRecoverer delegate;
    private final KafkaSdkProperties props;
    private final SdkNotifier notifier;

    public NotifyingRecoverer(ConsumerRecordRecoverer delegate, KafkaSdkProperties props, SdkNotifier notifier) {
        this.delegate = Objects.requireNonNull(delegate);
        this.props = Objects.requireNonNull(props);
        this.notifier = Objects.requireNonNull(notifier);
    }

    @Override
    public void accept(ConsumerRecord<?, ?> record, Exception exception) {
        // record should NOT be null here for record-level recovery; but guard anyway
        if (record == null) {
            notifier.onBadPayload(null, exception);
            return;
        }

        Throwable root = rootCause(exception);

        if (isBadPayload(root)) {
            notifier.onBadPayload(record, exception);
            // If you want to SKIP instead of DLT, return here.
            // If you want DLT + notify, fall through to delegate.
        }

        try {
            delegate.accept(record, exception);
        } catch (Exception publishEx) {
            notifier.onDlqPublishFailed(record, exception, publishEx);
            // do NOT throw endlessly
        }
    }

    private boolean isBadPayload(Throwable t) {
        return t instanceof DeserializationException
                || t instanceof SerializationException
                || (t != null && t.getMessage() != null && t.getMessage().contains("Unknown magic byte"));
    }

    private Throwable rootCause(Throwable t) {
        Throwable cur = t;
        while (cur.getCause() != null && cur.getCause() != cur) {
            cur = cur.getCause();
        }
        return cur;
    }
}