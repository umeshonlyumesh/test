import org.apache.kafka.clients.admin.*;
import org.apache.kafka.common.TopicPartition;

import java.util.*;
import java.util.concurrent.ExecutionException;

public class KafkaClusterConsumers {

  private final AdminClient admin;

  public KafkaClusterConsumers(AdminClient admin) {
    this.admin = admin;
  }

  public List<MemberView> listConsumersForTopic(String topic) {
    try {
      // 1) list all groups
      Collection<ConsumerGroupListing> groups = admin.listConsumerGroups().all().get();

      List<String> groupIds = groups.stream().map(ConsumerGroupListing::groupId).toList();

      // 2) describe groups (members + assignments)
      Map<String, ConsumerGroupDescription> desc =
          admin.describeConsumerGroups(groupIds).all().get();

      List<MemberView> result = new ArrayList<>();

      for (var e : desc.entrySet()) {
        String groupId = e.getKey();
        ConsumerGroupDescription d = e.getValue();

        d.members().forEach(m -> {
          boolean consumesTopic = m.assignment().topicPartitions().stream()
              .anyMatch(tp -> tp.topic().equals(topic));

          if (consumesTopic) {
            // collect partitions of that topic for this member
            List<Integer> partitions = m.assignment().topicPartitions().stream()
                .filter(tp -> tp.topic().equals(topic))
                .map(TopicPartition::partition)
                .sorted()
                .toList();

            result.add(new MemberView(
                topic,
                groupId,
                m.memberId(),
                m.clientId(),
                m.host(),
                partitions
            ));
          }
        });
      }

      return result;

    } catch (InterruptedException ie) {
      Thread.currentThread().interrupt();
      throw new RuntimeException("Interrupted", ie);
    } catch (ExecutionException ee) {
      throw new RuntimeException("AdminClient failed", ee);
    }
  }

  public record MemberView(
      String topic,
      String groupId,
      String memberId,
      String clientId,
      String host,
      List<Integer> partitions
  ) {}
}