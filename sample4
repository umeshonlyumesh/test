package com.example.demoavro.consumer;

import org.apache.avro.generic.GenericRecord;
import org.apache.kafka.clients.consumer.ConsumerRecord;
import org.apache.kafka.clients.consumer.ConsumerRecords;
import org.apache.kafka.clients.consumer.KafkaConsumer;
import org.apache.kafka.common.errors.WakeupException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import jakarta.annotation.PostConstruct;
import jakarta.annotation.PreDestroy;
import java.time.Duration;
import java.util.Arrays;
import java.util.Properties;
import java.util.concurrent.atomic.AtomicBoolean;

@Component
public class UnifiedConsumer {

    private static final Logger log = LoggerFactory.getLogger(UnifiedConsumer.class);

    private final Properties consumerProperties;

    @Value("${app.topics.employee}")
    private String employeeTopic;

    @Value("${app.topics.employee-dlt}")
    private String employeeDltTopic;

    @Value("${app.kafka.consumer.enabled:true}")
    private boolean enabled;

    @Value("${app.kafka.consumer.poll-ms:1000}")
    private long pollMs;

    private KafkaConsumer<String, Object> consumer;
    private Thread consumerThread;
    private final AtomicBoolean running = new AtomicBoolean(false);

    public UnifiedConsumer(Properties consumerProperties) {
        this.consumerProperties = consumerProperties;
    }

    @PostConstruct
    public void start() {
        if (!enabled) {
            log.info("UnifiedConsumer is disabled by configuration (app.kafka.consumer.enabled=false)");
            return;
        }
        this.consumer = new KafkaConsumer<>(consumerProperties);
        this.consumer.subscribe(Arrays.asList(employeeTopic, employeeDltTopic));
        running.set(true);
        this.consumerThread = new Thread(this::pollLoop, "unified-consumer-thread");
        this.consumerThread.start();
        log.info("UnifiedConsumer started; subscribed to topics: {}, {}", employeeTopic, employeeDltTopic);
    }

    private void pollLoop() {
        try {
            while (running.get()) {
                ConsumerRecords<String, Object> records = consumer.poll(Duration.ofMillis(pollMs));
                for (ConsumerRecord<String, Object> record : records) {
                    handleRecord(record);
                }
            }
        } catch (WakeupException we) {
            if (running.get()) {
                log.warn("Consumer wakeup due to unexpected condition: {}", we.getMessage());
            }
        } catch (Exception e) {
            log.error("Error in consumer loop: {}", e.getMessage(), e);
        } finally {
            try {
                consumer.close();
            } catch (Exception e) {
                log.warn("Error closing consumer: {}", e.getMessage());
            }
            log.info("UnifiedConsumer stopped");
        }
    }

    private void handleRecord(ConsumerRecord<String, Object> record) {
        Object value = record.value();
        String key = record.key();
        String topic = record.topic();
        boolean isDlt = topic.equals(employeeDltTopic);
        if (isDlt) {
            log.error("Received message on DLT: topic={}, partition={}, offset={}, key={}, value={}",
                    topic, record.partition(), record.offset(), key, value);
            return;
        }
        if (value instanceof GenericRecord employee) {
            log.info("Consumed Employee (Avro): key={}, name={} {}, dob={}, from partition={}, offset={}",
                    key, employee.get("firstName"), employee.get("lastName"), employee.get("dob"), record.partition(), record.offset());
        } else if (value instanceof String s) {
            log.info("Consumed Employee (String): key={}, value='{}', from partition={}, offset={}",
                    key, s, record.partition(), record.offset());
        } else if (value == null) {
            log.warn("Consumed null value: key={}, partition={}, offset={}", key, record.partition(), record.offset());
        } else {
            log.info("Consumed Employee (Unknown type {}): key={}, value={}, partition={}, offset={}",
                    value.getClass().getName(), key, value, record.partition(), record.offset());
        }
    }

    @PreDestroy
    public void stop() {
        if (!enabled) return;
        running.set(false);
        if (consumer != null) {
            consumer.wakeup();
        }
        if (consumerThread != null) {
            try {
                consumerThread.join(2000);
            } catch (InterruptedException e) {
                Thread.currentThread().interrupt();
            }
        }
    }
}
