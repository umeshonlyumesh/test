package com.truist.core.integration.orchestration.impl;

import com.truist.core.integration.model.*;
import com.truist.core.integration.orchestration.OperationExecutor;
import com.truist.core.integration.orchestration.OperationExecutorRegistry;
import com.truist.core.integration.orchestration.strategy.impl.FraudCheckExecutor;
import com.truist.core.integration.exception.SdkException;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.*;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

class FraudCheckExecutorTest {

    @Mock
    private OperationExecutorRegistry registry;

    @Mock
    private OperationExecutor fraudExecutor;

    private FraudCheckExecutor fraudCheckExecutor;

    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);
        fraudCheckExecutor = new FraudCheckExecutor(registry);
    }

    @Test
    void shouldReturnSuccessWhenExecutorReturnsValidResponse() {
        // Arrange
        FraudRequest requestPayload = FraudRequest.builder().customerId("C1001").build();
        Header header = Header.builder().requestId("R-001").sourceId("CORE").build();

        FraudResponse fraudResponse = FraudResponse.builder()
                .returnCode("00")
                .riskLevel("LOW")
                .build();

        OrchestratedRequest orchestratedRequest = OrchestratedRequest.builder()
                .operationType(OperationType.FraudCheck.name())
                .header(header)
                .requestPayload(requestPayload)
                .build();

        when(registry.getExecutor(OperationType.FraudCheck.name())).thenReturn(fraudExecutor);
        when(fraudExecutor.execute(any())).thenReturn(fraudResponse);

        // Act
        CoreIntegrationResponse response = fraudCheckExecutor.orchestrate(orchestratedRequest);

        // Assert
        assertNotNull(response);
        assertEquals("SUCCESS", response.getStatus());
        assertTrue(response.getPayload() instanceof java.util.Map);
        verify(registry, times(1)).getExecutor(OperationType.FraudCheck.name());
        verify(fraudExecutor, times(1)).execute(any());
    }

    @Test
    void shouldReturnFailedWhenExecutorNotFound() {
        // Arrange
        FraudRequest payload = FraudRequest.builder().customerId("C2001").build();
        Header header = Header.builder().requestId("R-002").build();
        OrchestratedRequest req = OrchestratedRequest.builder()
                .operationType(OperationType.FraudCheck.name())
                .header(header)
                .requestPayload(payload)
                .build();

        when(registry.getExecutor(OperationType.FraudCheck.name())).thenReturn(null);

        // Act
        CoreIntegrationResponse response = fraudCheckExecutor.orchestrate(req);

        // Assert
        assertNotNull(response);
        assertEquals("FAILED", response.getStatus());
        assertTrue(response.getErrorMessage().contains("CONFIG_ERROR"));
        verify(registry, times(1)).getExecutor(OperationType.FraudCheck.name());
        verify(fraudExecutor, never()).execute(any());
    }

    @Test
    void shouldThrowSdkExceptionWhenExecutorThrowsSdkError() {
        // Arrange
        FraudRequest payload = FraudRequest.builder().customerId("C3001").build();
        Header header = Header.builder().requestId("R-003").build();

        OrchestratedRequest req = OrchestratedRequest.builder()
                .operationType(OperationType.FraudCheck.name())
                .header(header)
                .requestPayload(payload)
                .build();

        when(registry.getExecutor(OperationType.FraudCheck.name())).thenReturn(fraudExecutor);
        when(fraudExecutor.execute(any())).thenThrow(new SdkException("SDK-1001", "Downstream error", "API-ERR", header));

        // Act & Assert
        SdkException ex = assertThrows(SdkException.class, () -> fraudCheckExecutor.orchestrate(req));
        assertEquals("SDK-1001", ex.getErrorCode());
        assertTrue(ex.getMessage().contains("Downstream error"));
    }

    @Test
    void shouldHandleGenericExceptionGracefully() {
        // Arrange
        FraudRequest payload = FraudRequest.builder().customerId("C4001").build();
        Header header = Header.builder().requestId("R-004").build();

        OrchestratedRequest req = OrchestratedRequest.builder()
                .operationType(OperationType.FraudCheck.name())
                .header(header)
                .requestPayload(payload)
                .build();

        when(registry.getExecutor(OperationType.FraudCheck.name())).thenThrow(new RuntimeException("Unexpected failure"));

        // Act & Assert
        SdkException ex = assertThrows(SdkException.class, () -> fraudCheckExecutor.orchestrate(req));
        assertEquals("Unexpected failure", ex.getMessage());
    }
}