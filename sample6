package com.example.awssecrets;

import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.retry.annotation.Backoff;
import org.springframework.retry.annotation.Retryable;
import software.amazon.awssdk.core.SdkBytes;
import software.amazon.awssdk.core.exception.SdkClientException;
import software.amazon.awssdk.services.secretsmanager.SecretsManagerClient;
import software.amazon.awssdk.services.secretsmanager.model.GetSecretValueRequest;
import software.amazon.awssdk.services.secretsmanager.model.GetSecretValueResponse;
import software.amazon.awssdk.services.secretsmanager.model.InternalServiceErrorException;

import java.util.Base64;
import java.util.Collections;
import java.util.HashMap;
import java.util.Map;

/**
 * Three canonical methods ONLY:
 *  - getSecret(secretKey)        : text/JSON by key
 *  - getBinarySecret(secretKey)  : binary by key
 *  - getSecretByArn(secretArn)   : text/JSON by ARN
 */
public class SecretManagerService {

    private final SecretsManagerClient client;
    private final SecretsCache cache;
    private final ObjectMapper mapper = new ObjectMapper();

    public SecretManagerService(SecretsManagerClient client, SecretsCache cache) {
        this.client = client;
        this.cache = cache;
    }

    /** Fetch string/JSON secret by KEY (name). */
    @Retryable(
        value = { SdkClientException.class, InternalServiceErrorException.class },
        maxAttempts = 3, backoff = @Backoff(delay = 500, multiplier = 2.0)
    )
    public Map<String, String> getSecret(String secretKey) {
        Map<String, String> cached = cache.getText(secretKey);
        if (cached != null) return cached;

        GetSecretValueResponse resp = client.getSecretValue(
                GetSecretValueRequest.builder().secretId(secretKey).build());

        Map<String, String> map = parseStringOrJson(resp);
        cache.putText(secretKey, map);
        return map;
    }

    /** Fetch BINARY secret by KEY (name). */
    @Retryable(
        value = { SdkClientException.class, InternalServiceErrorException.class },
        maxAttempts = 3, backoff = @Backoff(delay = 500, multiplier = 2.0)
    )
    public byte[] getBinarySecret(String secretKey) {
        byte[] cached = cache.getBinary(secretKey);
        if (cached != null) return cached;

        GetSecretValueResponse resp = client.getSecretValue(
                GetSecretValueRequest.builder().secretId(secretKey).build());

        byte[] data;
        if (resp.secretBinary() != null) {
            data = resp.secretBinary().asByteArray();
        } else if (resp.secretString() != null) {
            data = resp.secretString().getBytes(java.nio.charset.StandardCharsets.UTF_8);
        } else {
            data = new byte[0];
        }
        cache.putBinary(secretKey, data);
        return data;
    }

    /** Fetch string/JSON secret by ARN. */
    @Retryable(
        value = { SdkClientException.class, InternalServiceErrorException.class },
        maxAttempts = 3, backoff = @Backoff(delay = 500, multiplier = 2.0)
    )
    public Map<String, String> getSecretByArn(String secretArn) {
        Map<String, String> cached = cache.getText(secretArn);
        if (cached != null) return cached;

        GetSecretValueResponse resp = client.getSecretValue(
                GetSecretValueRequest.builder().secretId(secretArn).build());

        Map<String, String> map = parseStringOrJson(resp);
        cache.putText(secretArn, map);
        return map;
    }

    /** Helper: parse string/JSON, or convert binary to base64 if needed. */
    private Map<String, String> parseStringOrJson(GetSecretValueResponse resp) {
        if (resp.secretString() != null) {
            String raw = resp.secretString().trim();
            // Try JSON
            if ((raw.startsWith("{") && raw.endsWith("}")) || (raw.startsWith("[") && raw.endsWith("]"))) {
                try {
                    Map<?, ?> m = mapper.readValue(raw, Map.class);
                    Map<String, String> out = new HashMap<>();
                    for (Map.Entry<?, ?> e : m.entrySet()) {
                        if (e.getKey() != null && e.getValue() != null) {
                            out.put(e.getKey().toString(), String.valueOf(e.getValue()));
                        }
                    }
                    return out;
                } catch (Exception ignore) {
                    // not JSON â†’ fall through
                }
            }
            return Collections.singletonMap("value", raw);
        }
        if (resp.secretBinary() != null) {
            SdkBytes sb = resp.secretBinary();
            String b64 = Base64.getEncoder().encodeToString(sb.asByteArray());
            return Collections.singletonMap("binary", b64);
        }
        return Collections.emptyMap();
    }
}