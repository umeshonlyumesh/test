@ExtendWith(MockitoExtension.class)
class EWSResponseForOnboardingTest {

    @Mock
    private RestClient restClient;

    @Mock
    private RestClient.RequestBodyUriSpec bodyUriSpec;

    @Mock
    private RestClient.RequestBodySpec bodySpec;

    @Mock
    private RestClient.RequestHeadersSpec<?> headersSpec;

    @Mock
    private RestClient.ResponseSpec responseSpec;

    @InjectMocks
    private EWSResponseForOnboarding service;

    @Test
    void testRun_success() throws Exception {
        // given
        String mockResponse = "Success";

        // 1️⃣ post()
        when(restClient.post()).thenReturn(bodyUriSpec);

        // 2️⃣ uri()  → returns RequestBodySpec
        when(bodyUriSpec.uri(eq("/company-enrollment/ews-update"))).thenReturn(bodySpec);
        // also support overload with params
        when(bodyUriSpec.uri(eq("/company-enrollment/ews-update"), any(Object[].class)))
                .thenReturn(bodySpec);

        // 3️⃣ contentType()  → returns RequestBodySpec
        when(bodySpec.contentType(eq(MediaType.APPLICATION_JSON))).thenReturn(bodySpec);

        // 4️⃣ body()  → returns RequestHeadersSpec
        when(bodySpec.body(any())).thenReturn(headersSpec);

        // 5️⃣ retrieve()  → returns ResponseSpec
        when(headersSpec.retrieve()).thenReturn(responseSpec);

        // 6️⃣ body(String.class) → returns final string
        when(responseSpec.body(String.class)).thenReturn(mockResponse);

        // when
        service.run();

        // then
        verify(restClient, times(1)).post();
        verify(headersSpec, times(1)).retrieve();
        verify(responseSpec, times(1)).body(String.class);
    }
}