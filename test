package com.truist.core.pez.validation;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.MockedStatic;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

/**
 * SonarQube-clean unit tests for {@link PostingValidation}.
 */
class PostingValidationTest {

    private CoreIntegrationRequest request;
    private Header header;
    private ValidationProperties props;
    private MemoPost memoPost;
    private PaymentInfo paymentInfo;

    @BeforeEach
    void setUp() {
        request = mock(CoreIntegrationRequest.class);
        header = mock(Header.class);
        props = mock(ValidationProperties.class);
        memoPost = mock(MemoPost.class);
        paymentInfo = mock(PaymentInfo.class);

        when(request.getHeader()).thenReturn(header);
        when(request.getMemoPost()).thenReturn(memoPost);
        when(request.getPaymentInfo()).thenReturn(paymentInfo);
        when(props.getSides()).thenReturn(java.util.List.of("CREDIT", "DEBIT"));
        when(memoPost.getSide()).thenReturn("CREDIT");
    }

    @Test
    void shouldThrowWhenMemoPostIsNull() {
        when(request.getMemoPost()).thenReturn(null);

        ValidationException ex = assertThrows(
                ValidationException.class,
                () -> PostingValidation.postingValidation(request, header, props)
        );

        assertTrue(ex.getMessage().contains("POSTING_ERROR"));
    }

    @Test
    void shouldThrowWhenSideIsEmpty() {
        when(memoPost.getSide()).thenReturn("");

        ValidationException ex = assertThrows(
                ValidationException.class,
                () -> PostingValidation.postingValidation(request, header, props)
        );

        assertTrue(ex.getMessage().contains("SIDE_VLD"));
    }

    @Test
    void shouldThrowWhenSideNotInAllowedList() {
        when(memoPost.getSide()).thenReturn("INVALID");

        ValidationException ex = assertThrows(
                ValidationException.class,
                () -> PostingValidation.postingValidation(request, header, props)
        );

        assertTrue(ex.getMessage().contains("SIDE_VLD"));
    }

    @Test
    void shouldCallPaymentInfoValidationWhenAllValid() {
        try (MockedStatic<PaymentInfoValidation> piv = mockStatic(PaymentInfoValidation.class)) {
            when(memoPost.getSide()).thenReturn("DEBIT");

            assertDoesNotThrow(() ->
                    PostingValidation.postingValidation(request, header, props)
            );

            piv.verify(() -> PaymentInfoValidation.validatePaymentInfoPayload(
                    eq("DEBIT"),
                    eq(paymentInfo),
                    eq(header),
                    eq(props)
            ), times(1));
        }
    }
}