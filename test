import { ComponentFixture, TestBed } from '@angular/core/testing';
import { CompanyEnrollmentComponent } from './company-enrollment.component';
import { FormBuilder, ReactiveFormsModule } from '@angular/forms';
import { Router, ActivatedRoute } from '@angular/router';
import { of } from 'rxjs';
import { AvsService } from 'src/app/services/avs.service';
import { CommonService } from 'src/app/services/common.service';

describe('CompanyEnrollmentComponent', () => {
  let component: CompanyEnrollmentComponent;
  let fixture: ComponentFixture<CompanyEnrollmentComponent>;
  let avsServiceSpy: any;
  let commonServiceSpy: any;
  let routerSpy: any;
  let activatedRouteStub: any;

  beforeEach(async () => {
    avsServiceSpy = jasmine.createSpyObj('AvsService', [
      'getCompanyById',
      'addOrUpdateCompanyEnrollments'
    ]);
    commonServiceSpy = jasmine.createSpyObj('CommonService', [
      'setAuth',
      'trimValue'
    ]);
    routerSpy = jasmine.createSpyObj('Router', ['navigate', 'navigateByUrl']);
    activatedRouteStub = {
      paramMap: of({
        get: (key: string) => {
          if (key === 'secondaryClientId') return 'mock-client-id';
          return null;
        }
      })
    };

    await TestBed.configureTestingModule({
      imports: [ReactiveFormsModule],
      declarations: [CompanyEnrollmentComponent],
      providers: [
        FormBuilder,
        { provide: AvsService, useValue: avsServiceSpy },
        { provide: CommonService, useValue: commonServiceSpy },
        { provide: Router, useValue: routerSpy },
        { provide: ActivatedRoute, useValue: activatedRouteStub }
      ]
    }).compileComponents();
  });

  beforeEach(() => {
    fixture = TestBed.createComponent(CompanyEnrollmentComponent);
    component = fixture.componentInstance;
    fixture.detectChanges();
  });

  it('should create component', () => {
    expect(component).toBeTruthy();
  });

  it('should set secondaryClientId and call fetchCompanyData in ngOnInit if in edit mode', () => {
    spyOn(component, 'fetchCompanyData');
    component.ngOnInit();
    expect(component.secondaryClientId).toBe('mock-client-id');
    expect(component.fetchCompanyData).toHaveBeenCalledWith('mock-client-id');
  });

  it('should initialize the form correctly in initForm()', () => {
    component.initForm();
    const form = component.ceFormGroup;
    expect(form).toBeTruthy();
    expect(form.contains('secondaryClientId')).toBeTrue();
    expect(form.contains('accountType')).toBeTrue();
  });

  it('should populate form with company data in fetchCompanyData()', () => {
    const mockData = {
      body: {
        statusCode: 200,
        data: {
          secondaryClientId: '123',
          accountType: 'Business'
        }
      }
    };
    avsServiceSpy.getCompanyById.and.returnValue(of(mockData));

    component.fetchCompanyData('123');

    expect(avsServiceSpy.getCompanyById).toHaveBeenCalledWith('123');
    expect(component.company).toEqual(mockData.body.data);
    expect(component.ceFormGroup.value.secondaryClientId).toBe('123');
    expect(component.isResponseSuccess).toBeTrue();
  });

  it('should show response message on save if form is invalid', () => {
    component.initForm();
    component.ceFormGroup.markAsTouched();
    component.onSaveCompanyEnrollment();
    expect(component.showResponse).toBeTrue();
    expect(component.isResponseSuccess).toBeFalse();
  });

  it('should submit company enrollment in onSaveCompanyEnrollment()', () => {
    component.initForm();
    component.ceFormGroup.patchValue({
      secondaryClientId: '123',
      accountType: 'Business'
    });
    component.isEditMode = false;

    const mockResponse = {
      body: {
        statusCode: 200
      }
    };

    avsServiceSpy.addOrUpdateCompanyEnrollments.and.returnValue(of(mockResponse));
    commonServiceSpy.trimValue.and.callFake((formGroup) => formGroup.value);

    component.onSaveCompanyEnrollment();

    expect(commonServiceSpy.trimValue).toHaveBeenCalledWith(component.ceFormGroup);
    expect(avsServiceSpy.addOrUpdateCompanyEnrollments).toHaveBeenCalled();
    expect(component.isResponseSuccess).toBeTrue();
  });

  it('should detect no changes and show response message without calling update', () => {
    component.initForm();
    component.ceFormGroup.patchValue({
      secondaryClientId: '123',
      accountType: 'Business'
    });
    component.isEditMode = true;
    component.originalFormValue = {
      secondaryClientId: '123',
      accountType: 'Business'
    };

    commonServiceSpy.trimValue.and.callFake((formGroup) => formGroup.value);

    component.onSaveCompanyEnrollment();

    expect(commonServiceSpy.trimValue).toHaveBeenCalledWith(component.ceFormGroup);
    expect(avsServiceSpy.addOrUpdateCompanyEnrollments).not.toHaveBeenCalled();
    expect(component.isResponseSuccess).toBeFalse();
    expect(component.showResponse).toBeTrue();
  });
});
