@ExtendWith(MockitoExtension.class)
class EWSResponseForOnboardingTest {

    @Mock private RestClient restClient;
    @Mock private RestClient.RequestBodyUriSpec bodyUriSpec;
    @Mock private RestClient.RequestBodySpec bodySpec;
    @Mock private RestClient.RequestHeadersSpec<?> headersSpec;
    @Mock private RestClient.ResponseSpec responseSpec;

    @InjectMocks private EWSResponseForOnboarding service;

    @Test
    void testCallAVS_success() throws Exception {
        List<CompanyStatusUpdate> ewsResponseList = List.of(
                new CompanyStatusUpdate("T00004444", null, "C")
        );
        String mockResponse = "Success";

        // 1️⃣ post() → bodyUriSpec
        when(restClient.post()).thenReturn(bodyUriSpec);

        // 2️⃣ uri() → bodySpec
        when(bodyUriSpec.uri(eq("/company-enrollment/ews-update")))
                .thenReturn(bodySpec);

        // 3️⃣ contentType() → bodySpec
        when(bodySpec.contentType(eq(MediaType.APPLICATION_JSON)))
                .thenReturn(bodySpec);

        // 4️⃣ body() → headersSpec
        // Tell Mockito this is the overload returning RequestHeadersSpec<?>
        @SuppressWarnings("unchecked")
        RestClient.RequestHeadersSpec<?> castedHeadersSpec = (RestClient.RequestHeadersSpec<?>) headersSpec;
        when(bodySpec.body(eq(ewsResponseList))).thenReturn(castedHeadersSpec);

        // 5️⃣ retrieve() → responseSpec
        when(headersSpec.retrieve()).thenReturn(responseSpec);

        // 6️⃣ body(String.class) → final response
        when(responseSpec.body(String.class)).thenReturn(mockResponse);

        // Reflectively call private method
        Method callAVSMethod = EWSResponseForOnboarding.class
                .getDeclaredMethod("callAVS", List.class);
        callAVSMethod.setAccessible(true);
        callAVSMethod.invoke(service, ewsResponseList);

        // ✅ Verify all fluent calls executed
        verify(restClient).post();
        verify(bodyUriSpec).uri("/company-enrollment/ews-update");
        verify(bodySpec).contentType(MediaType.APPLICATION_JSON);
        verify(bodySpec).body(eq(ewsResponseList));
        verify(headersSpec).retrieve();
        verify(responseSpec).body(String.class);
    }
}