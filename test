package com.example.validation;

import org.aspectj.lang.JoinPoint;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

/**
 * Unit tests for {@link CoreIntegrationAspect}.
 * Verifies before() behavior for various operations.
 */
class CoreIntegrationAspectTest {

    private CoreIntegrationAspect aspect;
    private JoinPoint joinPoint;
    private CoreIntegrationApiRequest request;
    private Header header;

    private static final String POSTING = "POSTING";
    private static final String QUALIFICATION = "QUALIFICATION";
    private static final String PAYMENT = "PAYMENT";
    private static final String VALIDATION_HEADER_ERROR = "VALIDATION_HEADER_ERROR";

    @BeforeEach
    void setUp() {
        aspect = Mockito.spy(new CoreIntegrationAspect());
        joinPoint = mock(JoinPoint.class);
        request = mock(CoreIntegrationApiRequest.class);
        header = mock(Header.class);

        when(joinPoint.getArgs()).thenReturn(new Object[]{request});
        when(request.getHeader()).thenReturn(header);
    }

    @Test
    void shouldThrowExceptionWhenHeaderIsNull() {
        when(request.getHeader()).thenReturn(null);

        ValidationException ex = assertThrows(
                ValidationException.class,
                () -> aspect.before(joinPoint)
        );

        assertTrue(ex.getMessage().contains(VALIDATION_HEADER_ERROR));
    }

    @Test
    void shouldInvokePostingValidationWhenOperationIsPosting() {
        when(request.getOperation()).thenReturn(POSTING);
        when(request.getMemoPos()).thenReturn(new Object());

        assertDoesNotThrow(() -> aspect.before(joinPoint));

        verify(aspect, times(1)).postingValidation(eq(request), eq(header));
    }

    @Test
    void shouldInvokeQualificationValidationWhenOperationIsQualification() {
        when(request.getOperation()).thenReturn(QUALIFICATION);
        when(request.getQualification()).thenReturn(new Object());

        assertDoesNotThrow(() -> aspect.before(joinPoint));

        verify(aspect, times(1)).qualificationValidation(eq(request), eq(header));
    }

    @Test
    void shouldInvokeValidateExtendedTransactionIdWhenOperationIsPayment() {
        when(request.getOperation()).thenReturn(PAYMENT);
        when(request.getPaymentInfo()).thenReturn(new PaymentInfo());

        assertDoesNotThrow(() -> aspect.before(joinPoint));

        verify(aspect, times(1))
                .validateExtendedTransactionId(any(PaymentInfo.class), eq(header));
    }

    @Test
    void shouldDoNothingWhenArgsAreEmpty() {
        when(joinPoint.getArgs()).thenReturn(new Object[]{});

        assertDoesNotThrow(() -> aspect.before(joinPoint));
        verifyNoInteractions(request);
    }
}