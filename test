package com.example.demo;

import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;
import org.mockito.junit.jupiter.MockitoSettings;
import org.mockito.quality.Strictness;
import org.mockito.Answers;
import org.springframework.http.MediaType;
import org.springframework.web.client.RestClient;

import static org.junit.jupiter.api.Assertions.assertThrows;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.mockito.ArgumentMatchers.any;
import static org.mockito.Mockito.when;

@ExtendWith(MockitoExtension.class)
@MockitoSettings(strictness = Strictness.LENIENT)
class EWSResponseForOnboardingTest {

    @Mock(answer = Answers.RETURNS_DEEP_STUBS)
    RestClient restClient;

    @InjectMocks
    EWSResponseForOnboarding service;

    @Test
    void run_callsAvsSuccessfully() throws Exception {
        // Arrange the RestClient fluent chain with deep stubs
        when(
                restClient.post()
                        .uri("/company-enrollment/ews-update")
                        .contentType(MediaType.APPLICATION_JSON)
                        .body(any())
                        .retrieve()
                        .body(String.class)
        ).thenReturn("OK");

        // Act & Assert: no exception should be thrown
        service.run();
    }

    @Test
    void run_throwsRuntimeException_whenAvsCallFails() {
        // Arrange: make the very first call throw to simulate client failure
        when(restClient.post()).thenThrow(new RuntimeException("boom"));

        // Act + Assert
        RuntimeException ex = assertThrows(RuntimeException.class, () -> {
            try {
                service.run();
            } catch (Exception e) {
                if (e instanceof RuntimeException re) throw re;
                throw new RuntimeException(e);
            }
        });
        assertTrue(ex.getMessage().contains("Error connecting to AVS: boom"));
    }
}
