@ExtendWith(MockitoExtension.class)
class EWSResponseForOnboardingTest {

    @Mock
    private RestClient restClient;

    @Mock
    private RestClient.RequestBodyUriSpec bodyUriSpec;

    @Mock
    private RestClient.RequestBodySpec bodySpec;

    @Mock
    private RestClient.RequestHeadersSpec<?> headersSpec;

    @Mock
    private RestClient.ResponseSpec responseSpec;

    @InjectMocks
    private EWSResponseForOnboarding service;

    @Test
    void testCallAVS_success() throws Exception {
        // Arrange
        List<CompanyStatusUpdate> ewsResponseList = List.of(
                new CompanyStatusUpdate("T00004444", null, "C")
        );
        String mockResponse = "Success";

        // ðŸ”¹ Step 1: restClient.post() â†’ bodyUriSpec
        when(restClient.post()).thenReturn(bodyUriSpec);

        // ðŸ”¹ Step 2: uri(...) â†’ bodySpec
        when(bodyUriSpec.uri(eq("/company-enrollment/ews-update"))).thenReturn(bodySpec);

        // ðŸ”¹ Step 3: contentType(...) â†’ bodySpec
        when(bodySpec.contentType(eq(MediaType.APPLICATION_JSON))).thenReturn(bodySpec);

        // ðŸ”¹ Step 4: body(...) â†’ headersSpec
        // This is the critical mock that matches your service code!
        when(bodySpec.body(eq(ewsResponseList))).thenReturn(headersSpec);

        // ðŸ”¹ Step 5: retrieve() â†’ responseSpec
        when(headersSpec.retrieve()).thenReturn(responseSpec);

        // ðŸ”¹ Step 6: body(String.class) â†’ final result
        when(responseSpec.body(String.class)).thenReturn(mockResponse);

        // Act
        Method callAVSMethod = EWSResponseForOnboarding.class
                .getDeclaredMethod("callAVS", List.class);
        callAVSMethod.setAccessible(true);
        callAVSMethod.invoke(service, ewsResponseList);

        // Assert
        verify(restClient, times(1)).post();
        verify(bodyUriSpec, times(1)).uri("/company-enrollment/ews-update");
        verify(bodySpec, times(1)).contentType(MediaType.APPLICATION_JSON);
        verify(bodySpec, times(1)).body(eq(ewsResponseList));
        verify(headersSpec, times(1)).retrieve();
        verify(responseSpec, times(1)).body(String.class);
    }
}