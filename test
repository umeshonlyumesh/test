@ExtendWith(MockitoExtension.class)
class EWSResponseForOnboardingTest {

    @Mock
    private RestClient restClient;
    @Mock
    private RestClient.RequestBodyUriSpec bodyUriSpec;
    @Mock
    private RestClient.RequestBodySpec bodySpec;
    @Mock
    private RestClient.RequestHeadersSpec<?> headersSpec;
    @Mock
    private RestClient.ResponseSpec responseSpec;

    @InjectMocks
    private EWSResponseForOnboarding service;

    @Test
    void testRun_success() throws Exception {
        String mockResponse = "Success";

        // Step 1: POST
        when(restClient.post()).thenReturn(bodyUriSpec);

        // Step 2: URI
        when(bodyUriSpec.uri(eq("/company-enrollment/ews-update"))).thenReturn(bodySpec);
        when(bodyUriSpec.uri(eq("/company-enrollment/ews-update"), any(Object[].class)))
                .thenReturn(bodySpec);

        // Step 3: contentType()
        when(bodySpec.contentType(eq(MediaType.APPLICATION_JSON))).thenReturn(bodySpec);

        // Step 4: body() â†’ workaround with lenient and cast
        // (force Mockito to accept any generic return)
        lenient().when(bodySpec.body(any())).thenAnswer(inv -> headersSpec);

        // Step 5: retrieve()
        when(headersSpec.retrieve()).thenReturn(responseSpec);

        // Step 6: body(String.class)
        when(responseSpec.body(String.class)).thenReturn(mockResponse);

        // Act
        service.run();

        // Assert
        verify(restClient, times(1)).post();
        verify(headersSpec, times(1)).retrieve();
        verify(responseSpec, times(1)).body(String.class);
    }
}