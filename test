@ExtendWith(MockitoExtension.class)
class EWSResponseForOnboardingTest {

    @Mock
    private RestClient restClient;
    @Mock
    private RestClient.RequestBodyUriSpec bodyUriSpec;
    @Mock
    private RestClient.RequestBodySpec bodySpec;
    @Mock
    private RestClient.RequestHeadersSpec<?> headersSpec;
    @Mock
    private RestClient.ResponseSpec responseSpec;

    @InjectMocks
    private EWSResponseForOnboarding service;

    @Test
    void testRun_success() throws Exception {
        String mockResponse = "Success";

        // 1️⃣ post() → bodyUriSpec
        when(restClient.post()).thenReturn(bodyUriSpec);

        // 2️⃣ uri() → bodySpec
        when(bodyUriSpec.uri(eq("/company-enrollment/ews-update")))
                .thenReturn(bodySpec);

        // 3️⃣ contentType() → bodySpec
        when(bodySpec.contentType(eq(MediaType.APPLICATION_JSON)))
                .thenReturn(bodySpec);

        // 4️⃣ body() → headersSpec
        // mock both overloads: body(Object) and body(Object, Class)
        lenient().when(bodySpec.body(any()))
                .thenReturn(headersSpec);
        lenient().when(bodySpec.body(any(), any(Class.class)))
                .thenReturn(headersSpec);

        // 5️⃣ retrieve() → responseSpec
        when(headersSpec.retrieve()).thenReturn(responseSpec);

        // 6️⃣ body(String.class) → final response
        when(responseSpec.body(String.class)).thenReturn(mockResponse);

        // act
        service.run();

        // assert
        verify(restClient, times(1)).post();
        verify(headersSpec, times(1)).retrieve();
        verify(responseSpec, times(1)).body(String.class);
    }
}