package com.truist.core.pez.validation;

import org.aspectj.lang.JoinPoint;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.Mockito;

import java.time.LocalDateTime;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

/**
 * Sonar-clean unit test for {@link ValidationAspect#before(JoinPoint)}.
 */
class ValidationAspectTest {

    private ValidationAspect aspect;
    private JoinPoint joinPoint;
    private CoreIntegrationRequest request;
    private Header header;
    private FraudValidation fraudValidation;
    private ValidationProperties validationProperties;

    private static final String FRAUD = "FRAUD";
    private static final String QUALIFICATION = "QUALIFICATION";
    private static final String POSTING = "POSTING";

    @BeforeEach
    void setUp() {
        fraudValidation = mock(FraudValidation.class);
        validationProperties = mock(ValidationProperties.class);

        aspect = Mockito.spy(new ValidationAspect(validationProperties));
        joinPoint = mock(JoinPoint.class);
        request = mock(CoreIntegrationRequest.class);
        header = mock(Header.class);

        when(joinPoint.getArgs()).thenReturn(new Object[]{request});
        when(request.getHeader()).thenReturn(header);
    }

    @Test
    void shouldThrowExceptionWhenHeaderIsNull() {
        when(request.getHeader()).thenReturn(null);

        ValidationException ex = assertThrows(
                ValidationException.class,
                () -> aspect.before(joinPoint)
        );

        assertTrue(ex.getMessage().contains("HEADER_ERROR"));
    }

    @Test
    void shouldInvokeFraudValidationWhenOperationIsFraud() {
        when(request.getHeader()).thenReturn(header);
        when(header.getOperation()).thenReturn(FRAUD);
        when(OperationType.fromValue(FRAUD)).thenReturn(OperationType.FRAUD);

        doNothing().when(aspect).headerValidation(any());
        doNothing().when(aspect).validateCreditAndTransactionId(any(), any());

        aspect.before(joinPoint);

        verify(aspect, times(1)).headerValidation(header);
        verify(aspect, times(1)).validateCreditAndTransactionId(request.getPaymentInfo(), header);
        // fraudValidation invoked indirectly through aspect
    }

    @Test
    void shouldInvokeQualificationValidationWhenOperationIsQualification() {
        when(header.getOperation()).thenReturn(QUALIFICATION);
        when(OperationType.fromValue(QUALIFICATION)).thenReturn(OperationType.QUALIFICATION);

        doNothing().when(aspect).headerValidation(any());
        doNothing().when(aspect).validateCreditAndTransactionId(any(), any());
        doNothing().when(aspect).qualificationValidation(any(), any());

        aspect.before(joinPoint);

        verify(aspect, times(1)).qualificationValidation(request, header);
    }

    @Test
    void shouldInvokePostingValidationWhenOperationIsPosting() {
        when(header.getOperation()).thenReturn(POSTING);
        when(OperationType.fromValue(POSTING)).thenReturn(OperationType.POSTING);

        doNothing().when(aspect).headerValidation(any());
        doNothing().when(aspect).validateCreditAndTransactionId(any(), any());
        doNothing().when(aspect).postingValidation(any(), any());

        aspect.before(joinPoint);

        verify(aspect, times(1)).postingValidation(request, header);
    }

    @Test
    void shouldDoNothingWhenJoinPointArgsAreEmpty() {
        when(joinPoint.getArgs()).thenReturn(new Object[]{});

        assertDoesNotThrow(() -> aspect.before(joinPoint));
        verifyNoInteractions(request);
    }
}