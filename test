package com.truist.core.pez.validation;

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.MockedStatic;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

/**
 * SonarQube-clean unit tests for {@link HeaderValidation}.
 */
class HeaderValidationTest {

    private Header header;
    private ValidationProperties props;

    @BeforeEach
    void setUp() {
        header = mock(Header.class);
        props = mock(ValidationProperties.class);

        when(props.getSourceIds()).thenReturn(java.util.List.of("SRC1", "SRC2"));
        when(header.getSourceId()).thenReturn("SRC1");
        when(header.getOperation()).thenReturn("FRAUD");
        when(header.getRequestId()).thenReturn("REQ-123");
    }

    @Test
    void shouldThrowWhenSourceIdIsEmpty() {
        when(header.getSourceId()).thenReturn(null);

        ValidationException ex = assertThrows(
                ValidationException.class,
                () -> HeaderValidation.headerValidation(header, props)
        );

        assertTrue(ex.getMessage().contains("SOURCE_ID_VLD"));
    }

    @Test
    void shouldThrowWhenSourceIdNotInAllowedList() {
        when(header.getSourceId()).thenReturn("INVALID");

        ValidationException ex = assertThrows(
                ValidationException.class,
                () -> HeaderValidation.headerValidation(header, props)
        );

        assertTrue(ex.getMessage().contains("SOURCE_ID_VLD"));
    }

    @Test
    void shouldThrowWhenOperationTypeIsNull() {
        when(header.getOperation()).thenReturn(null);

        ValidationException ex = assertThrows(
                ValidationException.class,
                () -> HeaderValidation.headerValidation(header, props)
        );

        assertTrue(ex.getMessage().contains("OPERATION_TYPE_VLD"));
    }

    @Test
    void shouldThrowWhenOperationTypeFromValueFails() {
        when(header.getOperation()).thenReturn("UNKNOWN");

        try (MockedStatic<OperationType> mockOp = mockStatic(OperationType.class)) {
            mockOp.when(() -> OperationType.fromValue("UNKNOWN"))
                    .thenThrow(new IllegalArgumentException("Invalid op"));

            ValidationException ex = assertThrows(
                    ValidationException.class,
                    () -> HeaderValidation.headerValidation(header, props)
            );

            assertTrue(ex.getMessage().contains("OPERATION_TYPE_VLD"));
        }
    }

    @Test
    void shouldThrowWhenRequestIdIsEmpty() {
        when(header.getRequestId()).thenReturn("");

        ValidationException ex = assertThrows(
                ValidationException.class,
                () -> HeaderValidation.headerValidation(header, props)
        );

        assertTrue(ex.getMessage().contains("REQUEST_ID_ERROR"));
    }

    @Test
    void shouldPassWhenAllValuesValid() {
        try (MockedStatic<OperationType> mockOp = mockStatic(OperationType.class)) {
            mockOp.when(() -> OperationType.fromValue("FRAUD"))
                    .thenReturn(OperationType.FRAUD);

            assertDoesNotThrow(() ->
                    HeaderValidation.headerValidation(header, props)
            );
        }
    }
}