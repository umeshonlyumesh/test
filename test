package com.truist.core.pez.validation;

import org.aspectj.lang.JoinPoint;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.MockedStatic;
import org.mockito.Mockito;

import static org.junit.jupiter.api.Assertions.*;
import static org.mockito.Mockito.*;

/**
 * SonarQube-clean unit test for {@link ValidationAspect#before(JoinPoint)}.
 */
class ValidationAspectTest {

    private ValidationAspect aspect;
    private JoinPoint joinPoint;
    private CoreIntegrationRequest request;
    private Header header;

    private static final String FRAUD = "FRAUD";
    private static final String QUALIFICATION = "QUALIFICATION";
    private static final String POSTING = "POSTING";

    @BeforeEach
    void setUp() {
        aspect = new ValidationAspect();
        joinPoint = mock(JoinPoint.class);
        request = mock(CoreIntegrationRequest.class);
        header = mock(Header.class);

        when(joinPoint.getArgs()).thenReturn(new Object[]{request});
        when(request.getHeader()).thenReturn(header);
        when(request.getPaymentInfo()).thenReturn(new PaymentInfo());
    }

    @Test
    void shouldThrowExceptionWhenHeaderIsNull() {
        when(request.getHeader()).thenReturn(null);

        ValidationException ex = assertThrows(
                ValidationException.class,
                () -> aspect.before(joinPoint)
        );

        assertTrue(ex.getMessage().contains("HEADER_ERROR"));
    }

    @Test
    void shouldInvokeFraudValidationWhenOperationIsFraud() {
        try (MockedStatic<HeaderValidation> hv = mockStatic(HeaderValidation.class);
             MockedStatic<CommonValidation> cv = mockStatic(CommonValidation.class);
             MockedStatic<FraudValidation> fv = mockStatic(FraudValidation.class);
             MockedStatic<QualificationValidation> qv = mockStatic(QualificationValidation.class);
             MockedStatic<PostingValidation> pv = mockStatic(PostingValidation.class)) {

            when(header.getOperation()).thenReturn(FRAUD);
            when(OperationType.fromValue(header.getOperation())).thenReturn(OperationType.FRAUD);

            aspect.before(joinPoint);

            hv.verify(() -> HeaderValidation.headerValidation(eq(header), any()), times(1));
            cv.verify(() -> CommonValidation.validateUtrAndTransactionId(any(), eq(header)), times(1));
            fv.verify(() -> FraudValidation.validateFraudPayload(eq(request), any()), times(1));
            qv.verifyNoInteractions();
            pv.verifyNoInteractions();
        }
    }

    @Test
    void shouldInvokeQualificationValidationWhenOperationIsQualification() {
        try (MockedStatic<HeaderValidation> hv = mockStatic(HeaderValidation.class);
             MockedStatic<CommonValidation> cv = mockStatic(CommonValidation.class);
             MockedStatic<FraudValidation> fv = mockStatic(FraudValidation.class);
             MockedStatic<QualificationValidation> qv = mockStatic(QualificationValidation.class);
             MockedStatic<PostingValidation> pv = mockStatic(PostingValidation.class)) {

            when(header.getOperation()).thenReturn(QUALIFICATION);
            when(OperationType.fromValue(header.getOperation())).thenReturn(OperationType.QUALIFICATION);

            aspect.before(joinPoint);

            hv.verify(() -> HeaderValidation.headerValidation(eq(header), any()), times(1));
            cv.verify(() -> CommonValidation.validateUtrAndTransactionId(any(), eq(header)), times(1));
            qv.verify(() -> QualificationValidation.qualificationValidation(eq(request), eq(header), any()), times(1));
            fv.verifyNoInteractions();
            pv.verifyNoInteractions();
        }
    }

    @Test
    void shouldInvokePostingValidationWhenOperationIsPosting() {
        try (MockedStatic<HeaderValidation> hv = mockStatic(HeaderValidation.class);
             MockedStatic<CommonValidation> cv = mockStatic(CommonValidation.class);
             MockedStatic<FraudValidation> fv = mockStatic(FraudValidation.class);
             MockedStatic<QualificationValidation> qv = mockStatic(QualificationValidation.class);
             MockedStatic<PostingValidation> pv = mockStatic(PostingValidation.class)) {

            when(header.getOperation()).thenReturn(POSTING);
            when(OperationType.fromValue(header.getOperation())).thenReturn(OperationType.POSTING);

            aspect.before(joinPoint);

            hv.verify(() -> HeaderValidation.headerValidation(eq(header), any()), times(1));
            cv.verify(() -> CommonValidation.validateUtrAndTransactionId(any(), eq(header)), times(1));
            pv.verify(() -> PostingValidation.postingValidation(eq(request), eq(header), any()), times(1));
            fv.verifyNoInteractions();
            qv.verifyNoInteractions();
        }
    }

    @Test
    void shouldDoNothingWhenJoinPointArgsEmpty() {
        when(joinPoint.getArgs()).thenReturn(new Object[]{});
        assertDoesNotThrow(() -> aspect.before(joinPoint));
    }
}